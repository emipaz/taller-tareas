{# 
  Plantilla: Dashboard del Usuario
  
  Descripci√≥n:
    Panel principal del usuario autenticado. Muestra navbar con opciones,
    formulario para cambiar contrase√±a, y lista de tareas asignadas.
    Usa HTMX para actualizaciones din√°micas sin recargar la p√°gina.
  
  Variables de contexto:
    - user (Usuario): Objeto del usuario autenticado (nombre, rol)
    - tareas (List[Tarea]): Lista de tareas asignadas al usuario
    - error (str, opcional): Mensaje de error
    - success (str, opcional): Mensaje de √©xito
  
  Endpoints:
    - POST /change-password: Cambiar contrase√±a del usuario
    - GET /tareas/usuario/{nombre}: Obtener tareas del usuario (HTMX)
    - GET /logout: Cerrar sesi√≥n
  
  Dependencias:
    - /static/main.css: Estilos globales
    - /static/common.js: Funci√≥n togglePasswordVisibility
    - htmx.org: Interactividad sin JavaScript manual
    - _tareas_fragment.html: Template parcial de tareas
  
  Funcionalidades:
    - Navbar con nombre del usuario y opciones
    - Formulario colapsable para cambiar contrase√±a
    - Validaci√≥n de contrase√±as coincidentes
    - Recarga din√°mica de tareas con HTMX
#}
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mis Tareas</title>
    <link rel="stylesheet" href="/static/main.css" />
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="/static/common.js"></script>
  </head>
  <body>
    {# Barra de navegaci√≥n superior #}
    <nav class="navbar">
      <div class="navbar-container">
        {# Informaci√≥n del usuario actual #}
        <div class="navbar-user">
          <span class="user-name">{{ user.nombre }}</span>
          <span class="user-role">({{ user.rol }})</span>
        </div>
        {# Enlaces de acci√≥n #}
        <div class="navbar-links">
          <a href="#" id="admin-trigger" class="{% if user.rol != 'admin' %}disabled-link{% endif %}" onclick="{% if user.rol == 'admin' %}toggleAdminMenu(event); return false;{% else %}return false;{% endif %}">
            Administraci√≥n {% if user.rol == 'admin' %}{% endif %}
          </a>
          <a href="#" onclick="togglePasswordForm(); return false;">Cambiar contrase√±a</a>
          <a href="/logout">Cerrar sesi√≥n</a>
        </div>
      </div>
      
      {# Men√∫ desplegable de administraci√≥n (fuera del navbar-links) #}
      {% if user.rol == "admin" %}
      <div class="admin-dropdown-menu" id="admin-menu" style="display: none;">
        <ul>
          <li><a href="#" onclick="toggleCreateUserForm(); closeAdminMenu(); return false;">‚ûï Crear usuario</a></li>
          <li><a href="/admin/users" onclick="closeAdminMenu();">üë• Ver usuarios</a></li>
          <li><a href="#" onclick="toggleCreateTaskForm(); closeAdminMenu(); return false;">üìã Crear tarea</a></li>
          <li><a href="/admin/stats" onclick="closeAdminMenu();">üìä Ver estad√≠sticas</a></li>
        </ul>
      </div>
      {% endif %}
    </nav>

    {# Mensajes de feedback al usuario #}
    {% if error %}
    <div class="error" style="background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px auto; max-width: 520px; border-radius: 4px; border: 1px solid #f5c6cb;">
      {{ error }}
    </div>
    {% endif %}

    {% if success %}
    <div class="success" style="background-color: #d4edda; color: #155724; padding: 10px; margin: 10px auto; max-width: 520px; border-radius: 4px; border: 1px solid #c3e6cb;">
      {{ success }}
    </div>
    {% endif %}

    {# Formulario colapsable para cambiar contrase√±a (oculto por defecto) #}
    <div id="password-form" style="display: none;" class="centered-form">
      <h3>Cambiar Contrase√±a</h3>
      <form method="post" action="/change-password" onsubmit="return validatePassword()">
        {# Campo de contrase√±a actual (para validar que es el usuario correcto) #}
        <div style="margin-bottom: 10px;">
          <label>Contrase√±a actual:<br>
            <div class="password-input-wrapper">
              <input id="current_password" name="current_password" type="password" required>
              <span class="toggle-password" onclick="togglePasswordVisibility('current_password', this)">üëÅÔ∏è</span>
            </div>
          </label>
        </div>
        {# Campo de nueva contrase√±a #}
        <div style="margin-bottom: 10px;">
          <label>Nueva contrase√±a:<br>
            <div class="password-input-wrapper">
              <input id="new_password" name="new_password" type="password" required>
              <span class="toggle-password" onclick="togglePasswordVisibility('new_password', this)">üëÅÔ∏è</span>
            </div>
          </label>
        </div>
        {# Campo de confirmaci√≥n (validaci√≥n en cliente) #}
        <div style="margin-bottom: 10px;">
          <label>Confirmar nueva contrase√±a:<br>
            <div class="password-input-wrapper">
              <input id="confirm_password" type="password" required>
              <span class="toggle-password" onclick="togglePasswordVisibility('confirm_password', this)">üëÅÔ∏è</span>
            </div>
          </label>
        </div>
        {# Mensaje de error si las contrase√±as no coinciden #}
        <div id="password-error" style="color: #ff6b6b; font-size: 0.9em; margin-bottom: 10px; display: none;">
          Las contrase√±as no coinciden
        </div>
        <div>
          <button type="submit">Cambiar</button>
          <button type="button" onclick="togglePasswordForm()">Cancelar</button>
        </div>
      </form>
    </div>

    {# Formulario para crear usuario (solo admin, oculto por defecto) #}
    {% if user.rol == "admin" %}
    <div id="create-user-form" style="display: none;" class="centered-form">
      <h3>‚ûï Crear Usuario</h3>
      <form method="post" action="/admin/create-user">
        <div style="margin-bottom: 10px;">
          <label>Nombre de usuario:<br>
            <input id="new_username" name="username" type="text" required>
          </label>
        </div>
        <div style="margin-bottom: 10px;">
          <label>Tipo de usuario:<br>
            <select name="role" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
              <option value="user">Usuario est√°ndar</option>
              <option value="admin">Administrador</option>
            </select>
          </label>
        </div>
        <div id="admin-password-fields" style="display: none;">
          <div style="margin-bottom: 10px;">
            <label>Contrase√±a (solo para admin):<br>
              <div class="password-input-wrapper">
                <input id="admin_password" name="password" type="password">
                <span class="toggle-password" onclick="togglePasswordVisibility('admin_password', this)">üëÅÔ∏è</span>
              </div>
            </label>
          </div>
        </div>
        <div>
          <button type="submit">Crear</button>
          <button type="button" onclick="toggleCreateUserForm()">Cancelar</button>
        </div>
      </form>
    </div>

    {# Formulario para crear tarea (solo admin, oculto por defecto) #}
    <div id="create-task-form" style="display: none;" class="centered-form">
      <h3>üìã Crear Tarea</h3>
      <form method="post" action="/admin/create-task">
        <div style="margin-bottom: 10px;">
          <label>Nombre de la tarea:<br>
            <input name="nombre" type="text" required>
          </label>
        </div>
        <div style="margin-bottom: 10px;">
          <label>Descripci√≥n:<br>
            <textarea name="descripcion" rows="4" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;" required></textarea>
          </label>
        </div>
        <div>
          <button type="submit">Crear</button>
          <button type="button" onclick="toggleCreateTaskForm()">Cancelar</button>
        </div>
      </form>
    </div>

    {# Contenedor para lista de usuarios (solo admin, oculto por defecto) #}
    <div id="users-list-container" style="display: none;">
      <div class="centered-form">
        <h3>üë• Usuarios del Sistema</h3>
        <div id="users-list" hx-get="/usuarios" hx-trigger="load" hx-swap="innerHTML">
          Cargando usuarios...
        </div>
        <button type="button" onclick="hideUsersList()" style="margin-top: 10px;">Cerrar</button>
      </div>
    </div>
    {% endif %}

    {# Contenido principal: lista de tareas #}
    <main>
      <div class="controls">
        {# Bot√≥n HTMX para recargar tareas sin refrescar p√°gina #}
        <button hx-get="/tareas/usuario/{{ user.nombre }}" hx-target="#lista">Recargar tareas</button>
      </div>

      {# Secci√≥n donde se renderizan las tareas (actualizable v√≠a HTMX) #}
      <section id="lista">
        {% include "_tareas_fragment.html" %}
      </section>
    </main>

    {# Scripts locales para funcionalidad del dashboard #}
    <script>
      /**
       * Alterna la visibilidad del men√∫ desplegable de administraci√≥n.
       * Cierra el formulario de contrase√±a si est√° abierto.
       * 
       * @param {Event} event - Evento del click
       * @returns {boolean}
       */
      function toggleAdminMenu(event) {
        event.preventDefault();
        // Cerrar formulario de contrase√±a
        document.getElementById('password-form').style.display = 'none';
        
        var menu = document.getElementById('admin-menu');
        if (menu.style.display === 'none' || menu.style.display === '') {
          menu.style.display = 'block';
        } else {
          menu.style.display = 'none';
        }
        return false;
      }

      /**
       * Cierra el men√∫ desplegable de administraci√≥n.
       * 
       * @returns {void}
       */
      function closeAdminMenu() {
        var menu = document.getElementById('admin-menu');
        if (menu) {
          menu.style.display = 'none';
        }
      }

      /**
       * Alterna la visibilidad del formulario de cambio de contrase√±a.
       * Cierra todos los dem√°s elementos (men√∫ admin, formularios admin).
       * 
       * Muestra/oculta el formulario colapsable y limpia los campos
       * cuando se abre para evitar que queden valores anteriores.
       * 
       * @returns {void}
       */
      function togglePasswordForm() {
        // Cerrar men√∫ de administraci√≥n
        closeAdminMenu();
        
        // Cerrar todos los formularios administrativos (solo si existen)
        var createUserForm = document.getElementById('create-user-form');
        var createTaskForm = document.getElementById('create-task-form');
        var usersListContainer = document.getElementById('users-list-container');
        
        if (createUserForm) createUserForm.style.display = 'none';
        if (createTaskForm) createTaskForm.style.display = 'none';
        if (usersListContainer) usersListContainer.style.display = 'none';
        
        var form = document.getElementById('password-form');
        var errorMsg = document.getElementById('password-error');
        if (form.style.display === 'none' || form.style.display === '') {
          form.style.display = 'block';
          // Limpiar campos al abrir
          document.getElementById('new_password').value = '';
          document.getElementById('confirm_password').value = '';
          errorMsg.style.display = 'none';
        } else {
          form.style.display = 'none';
        }
      }

      /**
       * Alterna la visibilidad del formulario de crear usuario.
       * Cierra todos los dem√°s elementos (men√∫ admin, password, otras formas).
       * 
       * @returns {void}
       */
      function toggleCreateUserForm() {
        // Cerrar men√∫ admin y formulario de contrase√±a
        closeAdminMenu();
        document.getElementById('password-form').style.display = 'none';
        
        // Cerrar otros formularios admin
        document.getElementById('create-task-form').style.display = 'none';
        document.getElementById('users-list-container').style.display = 'none';
        
        var form = document.getElementById('create-user-form');
        if (form.style.display === 'none' || form.style.display === '') {
          form.style.display = 'block';
          document.getElementById('new_username').value = '';
        } else {
          form.style.display = 'none';
        }
      }

      /**
       * Alterna la visibilidad del formulario de crear tarea.
       * Cierra todos los dem√°s elementos (men√∫ admin, password, otras formas).
       * 
       * @returns {void}
       */
      function toggleCreateTaskForm() {
        // Cerrar men√∫ admin y formulario de contrase√±a
        closeAdminMenu();
        document.getElementById('password-form').style.display = 'none';
        
        // Cerrar otros formularios admin
        document.getElementById('create-user-form').style.display = 'none';
        document.getElementById('users-list-container').style.display = 'none';
        
        var form = document.getElementById('create-task-form');
        if (form.style.display === 'none' || form.style.display === '') {
          form.style.display = 'block';
        } else {
          form.style.display = 'none';
        }
      }

      /**
       * Muestra la lista de usuarios.
       * Cierra otros formularios si est√°n abiertos.
       * 
       * @returns {void}
       */
      function showUsersList() {
        hideAllAdminForms();
        var container = document.getElementById('users-list-container');
        container.style.display = 'block';
        // HTMX cargar√° los usuarios autom√°ticamente
      }

      /**
       * Oculta la lista de usuarios.
       * 
       * @returns {void}
       */
      function hideUsersList() {
        document.getElementById('users-list-container').style.display = 'none';
      }

      /**
       * Oculta todos los formularios administrativos.
       * √ötil para asegurar que solo uno est√© visible a la vez.
       * 
       * @returns {void}
       */
      function hideAllAdminForms() {
        document.getElementById('create-user-form').style.display = 'none';
        document.getElementById('create-task-form').style.display = 'none';
        document.getElementById('users-list-container').style.display = 'none';
      }

      // Escuchar cambios en el select de tipo de usuario para mostrar campo de contrase√±a si es admin
      document.addEventListener('DOMContentLoaded', function() {
        // Cerrar men√∫ desplegable al hacer click fuera de √©l
        document.addEventListener('click', function(event) {
          var dropdown = document.querySelector('.dropdown');
          var menu = document.getElementById('admin-menu');
          if (dropdown && menu && !dropdown.contains(event.target)) {
            menu.style.display = 'none';
          }
        });

        var roleSelect = document.querySelector('select[name="role"]');
        if (roleSelect) {
          roleSelect.addEventListener('change', function() {
            var passwordFields = document.getElementById('admin-password-fields');
            var passwordInput = document.getElementById('admin_password');
            if (this.value === 'admin') {
              passwordFields.style.display = 'block';
              passwordInput.required = true;
            } else {
              passwordFields.style.display = 'none';
              passwordInput.required = false;
              passwordInput.value = '';
            }
          });
        }
      });
    </script>
  </body>
</html>
