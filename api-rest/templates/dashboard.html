{# 
  Plantilla: Dashboard del Usuario
  
  Descripci√≥n:
    Panel principal del usuario autenticado. Muestra navbar con opciones,
    formulario para cambiar contrase√±a, y lista de tareas asignadas.
    Usa HTMX para actualizaciones din√°micas sin recargar la p√°gina.
  
  Variables de contexto:
    - user (Usuario): Objeto del usuario autenticado (nombre, rol)
    - tareas (List[Tarea]): Lista de tareas asignadas al usuario
    - error (str, opcional): Mensaje de error
    - success (str, opcional): Mensaje de √©xito
  
  Endpoints:
    - POST /change-password: Cambiar contrase√±a del usuario
    - GET /tareas/usuario/{nombre}: Obtener tareas del usuario (HTMX)
    - GET /logout: Cerrar sesi√≥n
  
  Dependencias:
    - /static/main.css: Estilos globales
    - /static/common.js: Funci√≥n togglePasswordVisibility
    - htmx.org: Interactividad sin JavaScript manual
    - _tareas_fragment.html: Template parcial de tareas
  
  Funcionalidades:
    - Navbar con nombre del usuario y opciones
    - Formulario colapsable para cambiar contrase√±a
    - Validaci√≥n de contrase√±as coincidentes
    - Recarga din√°mica de tareas con HTMX
#}
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mis Tareas</title>
    <link rel="stylesheet" href="/static/main.css" />
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="/static/common.js"></script>
  </head>
  <body>
    {# Barra de navegaci√≥n superior #}
    <nav class="navbar">
      <div class="navbar-container">
        {# Informaci√≥n del usuario actual #}
        <div class="navbar-user">
          <span class="user-name">{{ user.nombre }}</span>
          <span class="user-role">({{ user.rol }})</span>
        </div>
        {# Enlaces de acci√≥n #}
        <div class="navbar-links">
          <a href="#" onclick="togglePasswordForm(); return false;">Cambiar contrase√±a</a>
          <a href="/logout">Cerrar sesi√≥n</a>
        </div>
      </div>
    </nav>

    {# Mensajes de feedback al usuario #}
    {% if error %}
    <div class="error" style="background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px auto; max-width: 520px; border-radius: 4px; border: 1px solid #f5c6cb;">
      {{ error }}
    </div>
    {% endif %}

    {% if success %}
    <div class="success" style="background-color: #d4edda; color: #155724; padding: 10px; margin: 10px auto; max-width: 520px; border-radius: 4px; border: 1px solid #c3e6cb;">
      {{ success }}
    </div>
    {% endif %}

    {# Formulario colapsable para cambiar contrase√±a (oculto por defecto) #}
    <div id="password-form" style="display: none;" class="centered-form">
      <h3>Cambiar Contrase√±a</h3>
      <form method="post" action="/change-password" onsubmit="return validatePassword()">
        {# Campo de contrase√±a actual (para validar que es el usuario correcto) #}
        <div style="margin-bottom: 10px;">
          <label>Contrase√±a actual:<br>
            <div class="password-input-wrapper">
              <input id="current_password" name="current_password" type="password" required>
              <span class="toggle-password" onclick="togglePasswordVisibility('current_password', this)">üëÅÔ∏è</span>
            </div>
          </label>
        </div>
        {# Campo de nueva contrase√±a #}
        <div style="margin-bottom: 10px;">
          <label>Nueva contrase√±a:<br>
            <div class="password-input-wrapper">
              <input id="new_password" name="new_password" type="password" required>
              <span class="toggle-password" onclick="togglePasswordVisibility('new_password', this)">üëÅÔ∏è</span>
            </div>
          </label>
        </div>
        {# Campo de confirmaci√≥n (validaci√≥n en cliente) #}
        <div style="margin-bottom: 10px;">
          <label>Confirmar nueva contrase√±a:<br>
            <div class="password-input-wrapper">
              <input id="confirm_password" type="password" required>
              <span class="toggle-password" onclick="togglePasswordVisibility('confirm_password', this)">üëÅÔ∏è</span>
            </div>
          </label>
        </div>
        {# Mensaje de error si las contrase√±as no coinciden #}
        <div id="password-error" style="color: #ff6b6b; font-size: 0.9em; margin-bottom: 10px; display: none;">
          Las contrase√±as no coinciden
        </div>
        <div>
          <button type="submit">Cambiar</button>
          <button type="button" onclick="togglePasswordForm()">Cancelar</button>
        </div>
      </form>
    </div>

    {# Contenido principal: lista de tareas #}
    <main>
      <div class="controls">
        {# Bot√≥n HTMX para recargar tareas sin refrescar p√°gina #}
        <button hx-get="/tareas/usuario/{{ user.nombre }}" hx-target="#lista">Recargar tareas</button>
      </div>

      {# Secci√≥n donde se renderizan las tareas (actualizable v√≠a HTMX) #}
      <section id="lista">
        {% include "_tareas_fragment.html" %}
      </section>
    </main>

    {# Scripts locales para funcionalidad del dashboard #}
    <script>
      /**
       * Alterna la visibilidad del formulario de cambio de contrase√±a.
       * 
       * Muestra/oculta el formulario colapsable y limpia los campos
       * cuando se abre para evitar que queden valores anteriores.
       * 
       * @returns {void}
       */
      function togglePasswordForm() {
        var form = document.getElementById('password-form');
        var errorMsg = document.getElementById('password-error');
        if (form.style.display === 'none') {
          form.style.display = 'block';
          // Limpiar campos al abrir
          document.getElementById('new_password').value = '';
          document.getElementById('confirm_password').value = '';
          errorMsg.style.display = 'none';
        } else {
          form.style.display = 'none';
        }
      }
    </script>
  </body>
</html>
