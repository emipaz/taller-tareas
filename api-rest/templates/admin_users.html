{# 
  Plantilla: Lista de Usuarios (Admin)
  
  Descripci√≥n:
    Muestra la lista completa de usuarios del sistema con paginaci√≥n,
    b√∫squeda y acciones administrativas.
  
  Variables de contexto:
    - user (Usuario): Usuario administrador autenticado
    - usuarios (List): Lista de usuarios
    - pagination (dict): Informaci√≥n de paginaci√≥n
    - search (str): T√©rmino de b√∫squeda actual
    - error (str, opcional): Mensaje de error
#}
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gesti√≥n de Usuarios - Admin</title>
    <link rel="stylesheet" href="/static/main.css" />
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
  </head>
  <body>
    {# Barra de navegaci√≥n superior #}
    <nav class="navbar">
      <div class="navbar-container">
        <div class="navbar-user">
          <span class="user-name">{{ user.nombre }}</span>
          <span class="user-role">({{ user.rol }})</span>
        </div>
        <div class="navbar-links">
          <a href="/">‚¨ÖÔ∏è Volver al Dashboard</a>
          <a href="/logout">Cerrar sesi√≥n</a>
        </div>
      </div>
    </nav>

    {# Mensajes de feedback #}
    {% if error %}
    <div class="error" style="background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px auto; max-width: 1200px; border-radius: 4px; border: 1px solid #f5c6cb;">
      {{ error }}
    </div>
    {% endif %}

    {# Mensajes de √©xito para operaciones de reset#}
    {% if request.query_params.get('reset_success') %}
    <div class="success" style="background-color: #d4edda; color: #155724; padding: 10px; margin: 10px auto; max-width: 1200px; border-radius: 4px; border: 1px solid #c3e6cb;">
      ‚úÖ Contrase√±a del usuario '{{ request.query_params.get('reset_success') }}' reseteada exitosamente
    </div>
    {% endif %}

    {# Mensajes de √©xito para operaciones de eliminaci√≥n #}
    {% if request.query_params.get('delete_success') %}
    <div class="success" style="background-color: #d4edda; color: #155724; padding: 10px; margin: 10px auto; max-width: 1200px; border-radius: 4px; border: 1px solid #c3e6cb;">
      ‚úÖ Usuario '{{ request.query_params.get('delete_success') }}' eliminado exitosamente
    </div>
    {% endif %}

    {# Mensajes de error para operaciones de reset #}
    {% if request.query_params.get('reset_error') %}
    <div class="error" style="background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px auto; max-width: 1200px; border-radius: 4px; border: 1px solid #f5c6cb;">
      ‚ùå {{ request.query_params.get('reset_error') }}
    </div>
    {% endif %}

    {# Mensajes de error para operaciones de eliminaci√≥n #}
    {% if request.query_params.get('delete_error') %}
    <div class="error" style="background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px auto; max-width: 1200px; border-radius: 4px; border: 1px solid #f5c6cb;">
      ‚ùå {{ request.query_params.get('delete_error') }}
    </div>
    {% endif %}

    {# Contenido principal #}
    <main style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
      <h2 style="color: #4a7ba7; margin-bottom: 20px;">üë• Gesti√≥n de Usuarios</h2>

      {# Barra de b√∫squeda #}
      <div style="margin-bottom: 20px;">
        <form method="get" action="/admin/users" style="display: flex; gap: 10px; align-items: center;">
          <input 
            type="text" 
            name="search" 
            placeholder="Buscar usuario..." 
            value="{{ search }}"
            style="flex: 1; padding: 10px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;"
          />
          <button type="submit" style="padding: 10px 20px; background: #4a7ba7; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
            üîç Buscar
          </button>
          {% if search %}
          <a href="/admin/users" style="padding: 10px 20px; background: #666; color: #fff; text-decoration: none; border-radius: 4px; display: inline-block;">
            ‚úñÔ∏è Limpiar
          </a>
          {% endif %}
        </form>
      </div>

      {# Tabla de usuarios con informaci√≥n completa y acciones administrativas #}
      <div style="background: #2a2929; border-radius: 8px; overflow: hidden; border: 1px solid #444;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #3a3939; border-bottom: 2px solid #4a7ba7;">
              {# Tabla de usuarios con informaci√≥n completa y acciones administrativas #}
              <th style="padding: 12px; text-align: left; color: #87ceeb; font-weight: 600;">üë§ Usuario</th>
              <th style="padding: 12px; text-align: left; color: #87ceeb; font-weight: 600;">üõ°Ô∏è Rol</th>
              <th style="padding: 12px; text-align: center; color: #87ceeb; font-weight: 600;">üîê Contrase√±a</th>
              <th style="padding: 12px; text-align: center; color: #87ceeb; font-weight: 600;">‚öôÔ∏è Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% if usuarios %}
              {% for usuario in usuarios %}
              <tr style="border-bottom: 1px solid #333;">
                <td style="padding: 12px; color: #e0e0e0;">{{ usuario.nombre }}</td>
                <td style="padding: 12px;">
                  {# Rol con badge distintivo (admin = azul, user = gris) #}
                  {% if usuario.rol == 'admin' %}
                  <span style="background: #4a7ba7; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 600;">ADMIN</span>
                  {% else %}
                  <span style="background: #666; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">USER</span>
                  {% endif %}
                </td>
                {# Estado de la contrase√±a (configurada o pendiente) #}
                <td style="padding: 12px; text-align: center;">
                  {% if usuario.tiene_password %}
                  <span style="color: #4caf50;">‚úÖ Configurada</span>
                  {% else %}
                  <span style="color: #ff9800;">‚ö†Ô∏è Sin configurar</span>
                  {% endif %}
                </td>

                {# Botones de acci√≥n: Resetear (todos) + Eliminar (solo users) #}
                <td style="padding: 12px; text-align: center;">
                  <div style="display: flex; gap: 8px; justify-content: center;">
                    {# Bot√≥n resetear: Disponible para todos los usuarios #}
                    <button 
                      style="padding: 6px 12px; background: #5a8bc7; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;"
                      onclick="resetPassword('{{ usuario.nombre }}')"
                    >
                      üîë Resetear
                    </button>

                    {# Bot√≥n eliminar: Solo visible para usuarios regulares (protege admins) #}
                    {% if usuario.rol != 'admin' %}
                    <button 
                      style="padding: 6px 12px; background: #d32f2f; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;"
                      onclick="deleteUser('{{ usuario.nombre }}')"
                    >
                      üóëÔ∏è Eliminar
                    </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              {# Mensaje cuando no hay resultados #}
              <tr>
                <td colspan="4" style="padding: 40px; text-align: center; color: #999;">
                  {% if search %}
                  No se encontraron usuarios con el t√©rmino "{{ search }}"
                  {% else %}
                  No hay usuarios registrados
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      {# Paginaci√≥n #}
      {% if pagination and pagination.total_pages > 1 %}
      <div style="margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 10px;">
        {% if pagination.has_prev %}
        <a href="/admin/users?page={{ pagination.prev_page }}{% if search %}&search={{ search }}{% endif %}" 
           style="padding: 8px 16px; background: #4a7ba7; color: #fff; text-decoration: none; border-radius: 4px;">
          ‚¨ÖÔ∏è Anterior
        </a>
        {% else %}
        <span style="padding: 8px 16px; background: #333; color: #666; border-radius: 4px;">‚¨ÖÔ∏è Anterior</span>
        {% endif %}

        <span style="color: #ccc;">
          P√°gina {{ pagination.current_page }} de {{ pagination.total_pages }} 
          ({{ pagination.total_items }} usuario{{ 's' if pagination.total_items != 1 else '' }})
        </span>

        {% if pagination.has_next %}
        <a href="/admin/users?page={{ pagination.next_page }}{% if search %}&search={{ search }}{% endif %}" 
           style="padding: 8px 16px; background: #4a7ba7; color: #fff; text-decoration: none; border-radius: 4px;">
          Siguiente ‚û°Ô∏è
        </a>
        {% else %}
        <span style="padding: 8px 16px; background: #333; color: #666; border-radius: 4px;">Siguiente ‚û°Ô∏è</span>
        {% endif %}
      </div>
      {% endif %}
    </main>

    <script>
      /**
       * Resetea la contrase√±a de un usuario a una temporal generada por el sistema.
       * 
       * Flujo:
       * 1. Muestra di√°logo de confirmaci√≥n con informaci√≥n sobre la acci√≥n
       * 2. Si se confirma, crea un formulario POST din√°micamente
       * 3. Env√≠a el formulario a /admin/reset-password con el nombre de usuario
       * 4. El servidor genera una contrase√±a temporal y la devuelve
       * 
       * @param {string} username - Nombre del usuario cuya contrase√±a se va a resetear
       * 
       * @example
       * resetPassword('juan');
       * // Muestra confirmaci√≥n ‚Üí POST /admin/reset-password ‚Üí Genera password temporal
       * 
       * @see POST /admin/reset-password en web.py
       * @see POST /auth/reset-password en api_rest.py
       */
      function resetPassword(username) {
        if (confirm(`¬øEst√°s seguro de resetear la contrase√±a del usuario "${username}"?\n\nSe generar√° una contrase√±a temporal que deber√°s comunicarle al usuario.`)) {
          // Crear formulario y enviarlo
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/admin/reset-password';
          // A√±adir campo oculto con el nombre de usuario
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'username';
          input.value = username;
          // A√±adir campo oculto con el token CSRF si es necesario
          form.appendChild(input);
          document.body.appendChild(form);
          form.submit();
        }
      }

      /**
       * Elimina permanentemente un usuario del sistema.
       * 
       * Implementa doble confirmaci√≥n para prevenir eliminaciones accidentales:
       * 1. Primer di√°logo: Muestra advertencias sobre la irreversibilidad
       * 2. Segundo prompt: Requiere escribir exactamente "ELIMINAR" para confirmar
       * 
       * Flujo:
       * - Muestra advertencia inicial con detalles de la operaci√≥n
       * - Si acepta, solicita escribir "ELIMINAR" como confirmaci√≥n
       * - Solo si escribe exactamente "ELIMINAR" se procede con la eliminaci√≥n
       * - Crea formulario POST y lo env√≠a a /admin/delete-user
       * 
       * @param {string} username - Nombre del usuario a eliminar
       * 
       * @example
       * deleteUser('juan');
       * // Confirmaci√≥n 1 ‚Üí Prompt "ELIMINAR" ‚Üí POST /admin/delete-user ‚Üí Usuario eliminado
       * 
       * @security
       * - Solo usuarios con rol 'user' pueden ser eliminados (admins protegidos en HTML)
       * - Requiere confirmaci√≥n expl√≠cita escribiendo "ELIMINAR"
       * - Valida coincidencia exacta (case-sensitive)
       * 
       * @see POST /admin/delete-user en web.py
       * @see DELETE /usuarios/{nombre} en api_rest.py
       */
      function deleteUser(username) {
        if (confirm(`‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\n¬øEst√°s COMPLETAMENTE SEGURO de eliminar el usuario "${username}"?\n\nEsta acci√≥n:\n‚Ä¢ Es IRREVERSIBLE\n‚Ä¢ Eliminar√° PERMANENTEMENTE el usuario\n‚Ä¢ No se puede deshacer\n\nEscribe "ELIMINAR" para confirmar.`)) {
          const confirmText = prompt('Escribe "ELIMINAR" para confirmar:');
          if (confirmText === 'ELIMINAR') {
            // Crear formulario y enviarlo
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/delete-user';
            // A√±adir campo oculto con el nombre de usuario
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'username';
            input.value = username;
            // A√±adir campo oculto con el token CSRF si es necesario
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
          } else {
            alert('Eliminaci√≥n cancelada. El texto no coincide.');
          }
        }
      }
    </script>
  </body>
</html>
